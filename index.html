<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <!-- <link rel="stylesheet" type="text/css" href="css/style.css" media="screen" /> -->
    <link rel="stylesheet" type="text/css" href="css/sequence-diagram-min.css" media="screen" />
    <title>Sequence Diagram</title>
    <style>
      html,body { height: 100%; margin: 0px; padding: 0px; }

      .editor { 
        width: 600px;
        height: 100vh;
        font-size: 14;
      }
      
      .editor-wrapper {
         width: 600px;
         height: 100vh;
         float: left;
      }

      .download {
        padding-left: 10px;
        text-decoration: none;
      }
    </style>
  </head>

  <body>


    <div id="main" class="row">
        <div class="editor-wrapper">
            <div class="editor">participant Adam as A
participant Christy as C

A->C: Says Hello
Note right of C: Christy thinks\nabout it
C-->A: How are you?
A->>C: I am good thanks!</div>
        </div>

        <div id="diagram">
          <div class="diagram">This should be a diagram! If you don't see it you need Javascript enabled</div>
          <a href="#" class="download">[ Download Diagram ]</a>
        </div>
    </div>
      
    <script src="js/jquery.min.js"></script>

    <!-- Needed for the text editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/ace.js" type="text/javascript" charset="utf-8"></script>

    <script src="js/webfont.js"></script>
    <script src="js/snap.svg-min.js"></script>
    <script src="js/underscore-min.js"></script>
    <script src="js/sequence-diagram-snap-min.js"></script>

    <script src="js/svginnerhtml.min.js"></script>
    <script type="text/javascript">

      var editor;
      function setup_editor(div) {
        var prevSavedData = window.localStorage.getItem('web-diagrams');
        if (prevSavedData) {
          console.debug('Resume saved value: ', prevSavedData)
          document.querySelector(".editor").innerHTML = prevSavedData.replace(/\{NEWLINE\}/g, '\n');
        }
        var editor_div = div.find(".editor");
        var diagram_div = div.find(".diagram");
        var theme_div = div.find(".theme");
        var download_link = div.find('.download');

        // Setup the editor diagram
        editor = ace.edit(editor_div.get(0));
        // editor.setTheme("ace/theme/crimson_editor");
        editor.setTheme("ace/theme/monokai");
        editor.getSession().setMode("ace/mode/asciidoc");
        editor.session.setUseWrapMode(true);
        editor.setFontSize(18);
        editor.getSession().on('change', _.debounce(on_change, 100));

        download_link.click(function(ev) {
          var svg = diagram_div.find('svg')[0];
          var width = parseInt(svg.width.baseVal.value);
          var height = parseInt(svg.height.baseVal.value);
          var data = editor.getValue();
          var xml = '<?xml version="1.0" encoding="utf-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd"><svg xmlns="http://www.w3.org/2000/svg" width="' + width + '" height="' + height + '" xmlns:xlink="http://www.w3.org/1999/xlink"><source><![CDATA[' + data + ']]></source>' + svg.innerHTML + '</svg>';

          var a = $(this);
          a.attr("download", "diagram.svg"); // TODO I could put title here
          a.attr("href", "data:image/svg+xml," + encodeURIComponent(xml));
        });

        theme_div.change(on_change);
        on_change();

        function on_change() {
          try {
            var diagram = Diagram.parse(editor.getValue());

            editor.getSession().setAnnotations([]);

            // Clear out old diagram
            diagram_div.html('');

            var options = {
              theme: 'simple',
              scale: 1
            };

            // Draw
            diagram.drawSVG(diagram_div.get(0), options);

          } catch(err) {
            var annotation = {
              type: "error", // also warning and information
              column: 0,
              row: 0,
              text: err.message
            };
            if (err instanceof Diagram.ParseError) {
              annotation.row    = err.loc.first_line - 1;
              annotation.column = err.loc.first_column;
            }
            editor.getSession().setAnnotations([annotation]);
            throw err;
          }
        }

      }
      
      function save() {
        var contentData = editor.getValue().replace(/\n/g, '{NEWLINE}');
        console.debug('Saving data: ', contentData);
        window.localStorage.setItem('web-diagrams', contentData);
      }

      onkeydown = function(e){
        if(e.ctrlKey && e.keyCode == 'S'.charCodeAt(0)){
          e.preventDefault();
          save();
        }
      }

      onbeforeunload = function(e) {
        save();
      };
      
      $(document).ready(function() {
        setup_editor($('#main'));
      });
    </script>
  </body>
</html>
